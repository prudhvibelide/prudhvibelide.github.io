<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Conference Services ‚Ä¢ eDesk</title>
  <style>
    :root{
      --gold:#cfb87c;
      --gold-2:#bfa766;
      --ink:#0f0f10;
      --panel:#1b1b1c;
      --panel-2:#242425;
      --panel-3:#2c2c2e;
      --text:#e9e9e9;
      --muted:#bdbdbd;
      --subtle:#8a8a8a;
      --ok:#3aafa9;
      --warn:#e79a00;
      --bad:#c03737;
      --shadow:0 14px 28px rgba(0,0,0,.35), 0 10px 10px rgba(0,0,0,.28);
      --radius-lg:18px;
      --radius:12px;
      --border:#2f2f31;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: "Segoe UI", system-ui, -apple-system, Roboto, Helvetica, Arial;
      color:var(--text);
      background: radial-gradient(1200px 600px at 15% 10%, #1b1b1c 0%, #111 60%, #0b0b0c 100%);
      background-attachment:fixed;
    }

    .container{max-width:1200px; margin:30px auto; padding:0 16px}

    /* Header */
    .header{
      display:flex; align-items:center; justify-content:space-between;
      gap:16px; margin-bottom:18px;
    }
    .brand{display:flex; align-items:center; gap:14px}
    .brand-badge{
      width:56px;height:56px;border-radius:12px;
      background:var(--gold);
      color:#1a1a1a; font-weight:900; display:grid; place-items:center; font-size:22px;
      box-shadow:var(--shadow);
    }
    .brand h1{margin:0; font-size:28px; letter-spacing:.2px; font-weight:900}
    .brand small{display:block; margin-top:2px; color:var(--muted); font-weight:700}

    .header-actions{display:flex; gap:10px; align-items:center}
    .pill{
      padding:8px 12px; border-radius:999px; background:rgba(207,184,124,.14);
      border:1px solid rgba(207,184,124,.35);
      color:var(--gold); font-weight:900; letter-spacing:.2px;
    }
    .btn{
      border:none; border-radius:10px; padding:10px 14px; font-weight:900; cursor:pointer;
      background:var(--panel-2); color:#ddd; display:flex; align-items:center; gap:8px;
      box-shadow:0 4px 12px rgba(0,0,0,.35);
    }
    .btn.primary{background:var(--gold); color:#1c1c1c}
    .btn.ghost{background:#2e2e30; color:#e6e6e6}
    .btn:hover{filter:brightness(1.06)}
    .btn:disabled{opacity:.55; cursor:not-allowed}

    /* Cards */
    .cards{
      display:grid; grid-template-columns:repeat(3,1fr); gap:18px;
      margin:18px 0 22px;
    }
    .card{
      background:linear-gradient(180deg,var(--panel) 0%, var(--panel-2) 100%);
      border-radius:var(--radius-lg); padding:20px; box-shadow:var(--shadow);
      border:1px solid var(--border);
    }
    .card h4{color:var(--gold); margin:0 0 8px 0; font-weight:900; letter-spacing:.3px}
    .card .big{font-size:22px; font-weight:900}
    .card .sub{color:var(--subtle); font-weight:700}

    /* Home */
    .hero{
      background:linear-gradient(180deg,var(--panel) 0%, var(--panel-2) 100%);
      border:1px solid var(--border);
      border-radius:var(--radius-lg);
      padding:22px;
      box-shadow:var(--shadow);
      margin-bottom:18px;
    }
    .hero-title{
      font-size:26px; font-weight:950; margin:0 0 6px 0;
    }
    .hero-desc{
      margin:0;
      color:var(--muted);
      font-weight:650;
      line-height:1.35;
    }
    .hall-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(220px, 1fr));
      gap:16px;
      margin-top:16px;
    }
    .hall-card{
      background:var(--panel-2);
      border:1px solid #303033;
      border-radius:16px;
      padding:16px;
      box-shadow:0 10px 18px rgba(0,0,0,.35);
      cursor:pointer;
      transition:transform .08s ease, filter .08s ease;
      position:relative;
      overflow:hidden;
    }
    .hall-card:hover{filter:brightness(1.05); transform:translateY(-1px)}
    .hall-card .kicker{color:var(--gold); font-weight:950; letter-spacing:.3px}
    .hall-card .name{font-size:22px; font-weight:950; margin:6px 0 8px}
    .hall-card .desc{color:#cfcfcf; font-weight:650; margin:0}
    .hall-card .corner{
      position:absolute; right:-18px; top:-18px;
      width:90px; height:90px; border-radius:28px;
      background:rgba(207,184,124,.14);
      border:1px solid rgba(207,184,124,.18);
      transform:rotate(12deg);
    }

    /* Tabs */
    .tabs{display:flex; flex-wrap:wrap; gap:10px; margin:14px 0 12px}
    .tab{
      background:var(--panel-2); color:#cfcfcf; border:1px solid #2f2f31;
      padding:10px 14px; border-radius:10px; font-weight:950; cursor:pointer;
      display:flex; align-items:center; gap:8px; box-shadow:0 8px 16px rgba(0,0,0,.35);
      user-select:none;
    }
    .tab.active{background:var(--gold); color:#1a1a1a; border-color:transparent}

    /* Section */
    .section{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:var(--radius-lg);
      padding:18px;
      box-shadow:var(--shadow);
    }
    .section-header{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:12px}
    .section-title{font-size:20px; font-weight:950}
    .search{
      display:flex; align-items:center; gap:10px; background:var(--panel-3);
      border-radius:10px; padding:10px 12px; border:1px solid #38383a;
      margin:10px 0 14px;
    }
    .search input{flex:1; background:transparent; border:none; outline:none; color:#e7e7e7; font-weight:650}

    /* Table */
    table{width:100%; border-collapse:separate; border-spacing:0 10px}
    thead th{
      color:var(--gold); font-size:13px; text-align:left; font-weight:950;
      padding:8px 10px;
    }
    tbody tr{
      background:var(--panel-2);
      box-shadow:0 8px 14px rgba(0,0,0,.35);
    }
    tbody td{
      padding:12px 10px;
      border-top:1px solid #303033; border-bottom:1px solid #303033;
      color:#ddd; vertical-align:top;
      word-break:break-word;
    }
    tbody tr td:first-child{border-left:1px solid #303033; border-top-left-radius:10px; border-bottom-left-radius:10px}
    tbody tr td:last-child{border-right:1px solid #303033; border-top-right-radius:10px; border-bottom-right-radius:10px}

    .badge{
      display:inline-block; padding:4px 10px; border-radius:9px;
      font-size:12px; font-weight:950;
      background:var(--panel-3); color:#eee; border:1px solid #3b3b3d;
      white-space:nowrap;
    }
    .badge.gold{background:rgba(207,184,124,.18); border-color:#6b5a2b; color:var(--gold)}
    .badge.ok{background:#294e4c; border-color:#357572; color:#b8fff7}
    .badge.warn{background:#4d3b12; border-color:#7d5a19; color:#ffd88b}
    .badge.bad{background:#402424; border-color:#6a3535; color:#ffb8b8}
    .badge.gray{background:#3a3a3d; border-color:#4b4b4d; color:#d0d0d2}

    .row-actions{display:flex; gap:10px; align-items:center}
    .icon-btn{
      background:transparent; border:none; cursor:pointer; font-size:18px; color:#cfcfcf
    }
    .icon-btn:hover{color:#fff}

    /* Modal */
    .modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.6); z-index:50}
    .modal.active{display:flex}
    .dialog{
      width:min(780px,92vw); background:var(--panel-2);
      border:1px solid #2e2e30; border-radius:16px;
      box-shadow:var(--shadow);
      padding:18px;
    }
    .dialog h3{margin:0 0 10px 0; font-weight:950}
    .form{display:grid; grid-template-columns:1fr 1fr; gap:14px}
    .form .full{grid-column:1/-1}
    .form label{
      font-size:12.5px; color:var(--muted); font-weight:950; display:block; margin-bottom:6px;
    }
    .form input,.form select,.form textarea{
      width:100%; background:var(--panel-3); border:1px solid #3a3a3d;
      color:#e8e8e8; border-radius:10px; padding:10px; font-weight:650;
    }
    .form textarea{min-height:110px; resize:vertical}
    .dialog-actions{display:flex; gap:10px; justify-content:flex-end; margin-top:14px}

    /* Links */
    a{color:#d7c890; text-decoration:none}
    a:hover{text-decoration:underline}

    /* Small screens */
    @media (max-width: 860px){
      .cards{grid-template-columns:1fr}
      .form{grid-template-columns:1fr}
      .header{flex-direction:column; align-items:flex-start}
      .header-actions{width:100%; justify-content:flex-start; flex-wrap:wrap}
    }
  </style>
</head>
<body>
  <div class="container">

    <div class="header">
      <div class="brand">
        <div class="brand-badge">CU</div>
        <div>
          <h1>Conference Services eDesk</h1>
          <small>University of Colorado Boulder</small>
        </div>
      </div>
      <div class="header-actions">
        <span class="pill" id="hall-pill" style="display:none;"></span>
        <button class="btn" id="homeBtn" style="display:none;">üè† <strong>Home</strong></button>
        <button class="btn ghost" id="exportBtn" style="display:none;">‚¨áÔ∏è <strong>Export Hall JSON</strong></button>
        <button class="btn primary" id="newBtn" style="display:none;">‚ûï <strong>New Entry</strong></button>
      </div>
    </div>

    <!-- HOME VIEW -->
    <div id="homeView">
      <div class="hero">
        <p class="hero-title">Welcome to Conference Services</p>
        <p class="hero-desc">
          Choose a hall to open its desk tools. Each hall keeps its own call logs, mail list, lost and found, desk notes, and documents.
          All entries are stored locally in your browser until you delete them.
        </p>

        <div class="hall-grid" id="hallGrid"></div>
      </div>

      <div class="cards">
        <div class="card">
          <h4>Manager</h4>
          <div class="big">Conference Services</div>
          <div class="sub">Front Desk Operations</div>
        </div>
        <div class="card">
          <h4>Data Storage</h4>
          <div class="big">Local Browser Storage</div>
          <div class="sub">Survives refresh until deleted</div>
        </div>
        <div class="card">
          <h4>Tip</h4>
          <div class="big">One Hall at a Time</div>
          <div class="sub">Pick Hall A‚ÄìE to manage entries</div>
        </div>
      </div>
    </div>

    <!-- HALL VIEW -->
    <div id="hallView" style="display:none;">
      <div class="cards">
        <div class="card">
          <h4>Hall</h4>
          <div class="big" id="hallNameCard">Hall A</div>
          <div class="sub">Active desk workspace</div>
        </div>
        <div class="card">
          <h4>Today</h4>
          <div class="big" id="todayCard">‚Äì</div>
          <div class="sub">Local time</div>
        </div>
        <div class="card">
          <h4>Hall Totals</h4>
          <div class="big" id="totalsCard">‚Äì</div>
          <div class="sub">Calls, Mail, Lost, Found, Notes, Docs</div>
        </div>
      </div>

      <div class="tabs" id="tabs"></div>

      <section class="section">
        <div class="section-header">
          <div class="section-title" id="sectionTitle">Desk Notes</div>
          <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
            <button class="btn ghost" id="clearSearchBtn" title="Clear search">üßπ <strong>Clear</strong></button>
            <button class="btn primary" id="addBtn">‚ûï <strong>Add</strong></button>
          </div>
        </div>

        <div class="search">
          <input id="searchInput" placeholder="Search this tab..." />
          üîé
        </div>

        <div id="contentArea"></div>
      </section>
    </div>

  </div>

  <!-- Modal -->
  <div class="modal" id="modal">
    <div class="dialog">
      <h3 id="modalTitle">Add Entry</h3>
      <div id="modalForm" class="form"></div>
      <div class="dialog-actions">
        <button class="btn ghost" id="modalCancel">Cancel</button>
        <button class="btn primary" id="modalSave">Save</button>
      </div>
    </div>
  </div>

  <script>
    /* ===========================
       Persistence Model (per hall)
       =========================== */

    const HALLS = ["Hall A","Hall B","Hall C","Hall D","Hall E"];
    const TAB_DEFS = [
      { id:"deskNotes", label:"üìù Desk Notes", title:"Desk Notes", addLabel:"Add Note" },
      { id:"callLog",  label:"üìû Call Log",   title:"Call Log",  addLabel:"Add Call" },
      { id:"mailList", label:"üì¨ Mail List",  title:"Mail List", addLabel:"Add Mail" },
      { id:"lost",     label:"üîç Lost",       title:"Lost Items",addLabel:"Add Lost Item" },
      { id:"found",    label:"üßæ Found",      title:"Found Items",addLabel:"Add Found Item" },
      { id:"docs",     label:"üìë Documents",  title:"Documents", addLabel:"Add Document" },
    ];

    const STORE_KEY = "cs_edesk_v2";

    const store = {
      loadAll(){
        try {
          const raw = localStorage.getItem(STORE_KEY);
          if(!raw) return { halls:{} };
          return JSON.parse(raw);
        } catch {
          return { halls:{} };
        }
      },
      saveAll(data){
        localStorage.setItem(STORE_KEY, JSON.stringify(data));
      },
      ensureHall(data, hallName){
        if(!data.halls) data.halls = {};
        if(!data.halls[hallName]){
          data.halls[hallName] = {
            callLog: [],
            mailList: [],
            lost: [],
            found: [],
            deskNotes: [],
            docs: []
          };
        }
        return data;
      }
    };

    const uid = () => Math.random().toString(36).slice(2) + Date.now().toString(36);
    const e = (s)=> String(s ?? "").replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
    const ea = (s)=> String(s ?? "").replace(/"/g,'&quot;');

    /* ===========================
       App State
       =========================== */

    const state = {
      hall: null,
      tab: "deskNotes",
      search: "",
      editing: null
    };

    /* ===========================
       Elements
       =========================== */

    const homeView = document.getElementById("homeView");
    const hallView = document.getElementById("hallView");
    const hallGrid = document.getElementById("hallGrid");

    const hallPill = document.getElementById("hall-pill");
    const homeBtn = document.getElementById("homeBtn");
    const exportBtn = document.getElementById("exportBtn");
    const newBtn = document.getElementById("newBtn");

    const tabsEl = document.getElementById("tabs");
    const sectionTitle = document.getElementById("sectionTitle");
    const contentArea = document.getElementById("contentArea");
    const addBtn = document.getElementById("addBtn");
    const searchInput = document.getElementById("searchInput");
    const clearSearchBtn = document.getElementById("clearSearchBtn");

    const hallNameCard = document.getElementById("hallNameCard");
    const todayCard = document.getElementById("todayCard");
    const totalsCard = document.getElementById("totalsCard");

    const modal = document.getElementById("modal");
    const modalTitle = document.getElementById("modalTitle");
    const modalForm = document.getElementById("modalForm");
    const modalCancel = document.getElementById("modalCancel");
    const modalSave = document.getElementById("modalSave");

    /* ===========================
       Navigation
       =========================== */

    function routeToHome(){
      state.hall = null;
      state.tab = "deskNotes";
      state.search = "";
      state.editing = null;
      setHash("");
      render();
    }

    function routeToHall(hallName){
      state.hall = hallName;
      state.tab = "deskNotes";
      state.search = "";
      state.editing = null;
      setHash("hall=" + encodeURIComponent(hallName) + "&tab=" + encodeURIComponent(state.tab));
      render();
    }

    function setTab(tabId){
      state.tab = tabId;
      state.search = "";
      state.editing = null;
      searchInput.value = "";
      setHash("hall=" + encodeURIComponent(state.hall) + "&tab=" + encodeURIComponent(state.tab));
      render();
    }

    function setHash(s){
      const h = s ? "#" + s : "";
      if(location.hash !== h) location.hash = h;
    }

    function parseHash(){
      const h = (location.hash || "").replace(/^#/, "").trim();
      if(!h) return { hall:null, tab:null };
      const params = new URLSearchParams(h);
      const hall = params.get("hall");
      const tab = params.get("tab");
      return {
        hall: hall ? decodeURIComponent(hall) : null,
        tab: tab ? decodeURIComponent(tab) : null
      };
    }

    window.addEventListener("hashchange", () => {
      const p = parseHash();
      if(!p.hall){
        state.hall = null;
        state.tab = "deskNotes";
      } else {
        state.hall = p.hall;
        state.tab = p.tab || "deskNotes";
      }
      state.search = "";
      searchInput.value = "";
      render();
    });

    /* ===========================
       Data Helpers
       =========================== */

    function getHallData(){
      const all = store.loadAll();
      store.ensureHall(all, state.hall);
      return all;
    }

    function getRowsForTab(all){
      const hallObj = all.halls[state.hall];
      return hallObj[state.tab] || [];
    }

    function saveRowsForTab(all, rows){
      all.halls[state.hall][state.tab] = rows;
      store.saveAll(all);
    }

    function computeTotals(all){
      const h = all.halls[state.hall];
      const totals = {
        calls: (h.callLog || []).length,
        mail: (h.mailList || []).length,
        lost: (h.lost || []).length,
        found: (h.found || []).length,
        notes: (h.deskNotes || []).length,
        docs: (h.docs || []).length,
      };
      return totals;
    }

    function nowString(){
      const d = new Date();
      const ds = d.toLocaleDateString(undefined, {year:"numeric", month:"short", day:"2-digit"});
      const ts = d.toLocaleTimeString(undefined, {hour:"numeric", minute:"2-digit"});
      return ds + " ‚Ä¢ " + ts;
    }

    /* ===========================
       Rendering
       =========================== */

    function renderHome(){
      hallGrid.innerHTML = HALLS.map(h => `
        <div class="hall-card" onclick="appPickHall('${ea(h)}')">
          <div class="corner"></div>
          <div class="kicker">Select Hall</div>
          <div class="name">${e(h)}</div>
          <p class="desc">Open logs and notes for ${e(h)}.</p>
        </div>
      `).join("");
    }

    function renderTabs(){
      tabsEl.innerHTML = TAB_DEFS.map(t => `
        <div class="tab ${t.id === state.tab ? "active" : ""}" onclick="appSetTab('${ea(t.id)}')">
          ${e(t.label)}
        </div>
      `).join("");
    }

    function renderHallHeaderCards(){
      hallNameCard.textContent = state.hall;
      todayCard.textContent = nowString();

      const all = getHallData();
      const totals = computeTotals(all);
      totalsCard.textContent = `${totals.calls}, ${totals.mail}, ${totals.lost}, ${totals.found}, ${totals.notes}, ${totals.docs}`;
    }

    function renderHallControls(){
      hallPill.style.display = "inline-block";
      hallPill.textContent = state.hall;

      homeBtn.style.display = "flex";
      exportBtn.style.display = "flex";
      newBtn.style.display = "flex";

      newBtn.onclick = () => openModalForTab(state.tab);
      homeBtn.onclick = () => routeToHome();
      exportBtn.onclick = () => exportHall();

      addBtn.onclick = () => openModalForTab(state.tab);

      clearSearchBtn.onclick = () => {
        state.search = "";
        searchInput.value = "";
        renderContent();
      };

      searchInput.oninput = (ev) => {
        state.search = ev.target.value || "";
        renderContent();
      };
    }

    function renderContent(){
      const def = TAB_DEFS.find(t => t.id === state.tab);
      sectionTitle.textContent = def ? def.title : "Workspace";

      const all = getHallData();
      const rows = getRowsForTab(all);
      const q = (state.search || "").toLowerCase();
      const filtered = q
        ? rows.filter(r => JSON.stringify(r).toLowerCase().includes(q))
        : rows;

      if(state.tab === "callLog") renderCallLog(filtered);
      else if(state.tab === "mailList") renderMailList(filtered);
      else if(state.tab === "lost") renderLost(filtered);
      else if(state.tab === "found") renderFound(filtered);
      else if(state.tab === "deskNotes") renderDeskNotes(filtered);
      else if(state.tab === "docs") renderDocs(filtered);
      else contentArea.innerHTML = `<div class="card"><div class="big">Unknown tab</div></div>`;

      renderHallHeaderCards();
    }

    function render(){
      if(!state.hall){
        homeView.style.display = "block";
        hallView.style.display = "none";
        hallPill.style.display = "none";
        homeBtn.style.display = "none";
        exportBtn.style.display = "none";
        newBtn.style.display = "none";
        renderHome();
        return;
      }

      homeView.style.display = "none";
      hallView.style.display = "block";

      renderTabs();
      renderHallControls();
      renderContent();
    }

    /* ===========================
       Table Renderers
       =========================== */

    function actionsCellHTML(tabId, rowId){
      return `
        <div class="row-actions">
          <button class="icon-btn" title="Edit" onclick="appEdit('${ea(tabId)}','${ea(rowId)}')">‚úèÔ∏è</button>
          <button class="icon-btn" title="Delete" onclick="appDelete('${ea(tabId)}','${ea(rowId)}')">üóëÔ∏è</button>
        </div>
      `;
    }

    function renderCallLog(rows){
      contentArea.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>Caller</th>
              <th>Phone</th>
              <th>Call Date/Time</th>
              <th>Message</th>
              <th>Taken By</th>
              <th>Best Callback</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${rows.map(r => `
              <tr>
                <td><strong>${e(r.whoCalled)}</strong></td>
                <td>${e(r.phoneNumber)}</td>
                <td>${e(r.callDateTime)}</td>
                <td>${e(r.message)}</td>
                <td><span class="badge gold">${e(r.takenBy)}</span></td>
                <td>${e(r.bestCallback)}</td>
                <td>${actionsCellHTML("callLog", r._id)}</td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      `;
    }

    function renderMailList(rows){
      contentArea.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>Recipient</th>
              <th>From</th>
              <th>Carrier/Type</th>
              <th>Tracking</th>
              <th>Received</th>
              <th>Stored Location</th>
              <th>Status</th>
              <th>Picked Up</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${rows.map(r => `
              <tr>
                <td><strong>${e(r.recipient)}</strong></td>
                <td>${e(r.from)}</td>
                <td>${e(r.carrier)}</td>
                <td>${e(r.tracking)}</td>
                <td>${e(r.receivedDateTime)}</td>
                <td>${e(r.storageLocation)}</td>
                <td>${r.pickedUpDone ? `<span class="badge ok">Picked Up</span>` : `<span class="badge warn">At Desk</span>`}</td>
                <td>${r.pickedUpDone ? e(r.pickedUpDetails) : `<span class="badge gray">Not yet</span>`}</td>
                <td>${actionsCellHTML("mailList", r._id)}</td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      `;
    }

    function renderLost(rows){
      contentArea.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>Item</th>
              <th>Owner/Guest</th>
              <th>Contact</th>
              <th>Lost Date/Time</th>
              <th>Where Lost</th>
              <th>Notes</th>
              <th>Resolution</th>
              <th>Done</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${rows.map(r => `
              <tr>
                <td><strong>${e(r.item)}</strong></td>
                <td>${e(r.owner)}</td>
                <td>${e(r.contact)}</td>
                <td>${e(r.lostDateTime)}</td>
                <td>${e(r.whereLost)}</td>
                <td>${e(r.notes)}</td>
                <td>${r.resolution ? e(r.resolution) : `<span class="badge gray">No update</span>`}</td>
                <td>${r.done ? `<span class="badge ok">Done</span>` : `<span class="badge warn">Open</span>`}</td>
                <td>${actionsCellHTML("lost", r._id)}</td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      `;
    }

    function renderFound(rows){
      contentArea.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>Item</th>
              <th>Found Date/Time</th>
              <th>Found Where</th>
              <th>Added By</th>
              <th>Notes</th>
              <th>Claimed</th>
              <th>Claim Details</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${rows.map(r => `
              <tr>
                <td><strong>${e(r.item)}</strong></td>
                <td>${e(r.foundDateTime)}</td>
                <td>${e(r.foundWhere)}</td>
                <td><span class="badge gold">${e(r.addedBy)}</span></td>
                <td>${e(r.notes)}</td>
                <td>${r.claimed ? `<span class="badge ok">Claimed</span>` : `<span class="badge warn">Unclaimed</span>`}</td>
                <td>${r.claimed ? e(r.claimDetails) : `<span class="badge gray">Not claimed</span>`}</td>
                <td>${actionsCellHTML("found", r._id)}</td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      `;
    }

    function renderDeskNotes(rows){
      contentArea.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>Added By</th>
              <th>Date/Time</th>
              <th>Message</th>
              <th>Priority</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${rows.map(r => `
              <tr>
                <td><strong>${e(r.addedBy)}</strong></td>
                <td>${e(r.dateTime)}</td>
                <td>${e(r.message)}</td>
                <td>${priorityBadge(r.priority)}</td>
                <td>${actionsCellHTML("deskNotes", r._id)}</td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      `;
    }

    function renderDocs(rows){
      contentArea.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>Document</th>
              <th>Link</th>
              <th>Notes</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${rows.map(r => `
              <tr>
                <td><strong>${e(r.name)}</strong></td>
                <td>${r.url ? `<a href="${ea(r.url)}" target="_blank">${e(r.url)}</a>` : `<span class="badge gray">No link</span>`}</td>
                <td>${e(r.notes)}</td>
                <td>${actionsCellHTML("docs", r._id)}</td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      `;
    }

    function priorityBadge(p){
      const v = (p || "FYI").toUpperCase();
      if(v === "URGENT") return `<span class="badge bad">Urgent</span>`;
      if(v === "IMPORTANT") return `<span class="badge warn">Important</span>`;
      return `<span class="badge gray">FYI</span>`;
    }

    /* ===========================
       Modal Forms
       =========================== */

    function openModalForTab(tabId, rowId = null){
      state.editing = rowId;
      const isEdit = !!rowId;

      const titleMap = {
        callLog: isEdit ? "Edit Call Log" : "Add Call Log",
        mailList: isEdit ? "Edit Mail Entry" : "Add Mail Entry",
        lost: isEdit ? "Edit Lost Item" : "Add Lost Item",
        found: isEdit ? "Edit Found Item" : "Add Found Item",
        deskNotes: isEdit ? "Edit Desk Note" : "Add Desk Note",
        docs: isEdit ? "Edit Document" : "Add Document",
      };
      modalTitle.textContent = titleMap[tabId] || (isEdit ? "Edit Entry" : "Add Entry");

      const all = getHallData();
      const rows = all.halls[state.hall][tabId] || [];
      const row = rowId ? rows.find(r => r._id === rowId) : null;
      const v = (x)=> (x ?? "");

      if(tabId === "callLog"){
        modalForm.innerHTML = `
          <div><label>Who called</label><input id="whoCalled" value="${ea(v(row?.whoCalled))}" placeholder="Name"/></div>
          <div><label>Phone number</label><input id="phoneNumber" value="${ea(v(row?.phoneNumber))}" placeholder="(303) 555-1234"/></div>
          <div class="full"><label>Call date and time</label><input id="callDateTime" value="${ea(v(row?.callDateTime) || nowString())}" placeholder="Jan 30, 2026 ‚Ä¢ 10:15 AM"/></div>
          <div class="full"><label>Message</label><textarea id="message" placeholder="What did they say?">${e(v(row?.message))}</textarea></div>
          <div><label>Who took the call</label><input id="takenBy" value="${ea(v(row?.takenBy))}" placeholder="Staff name"/></div>
          <div><label>Best time/date to call back</label><input id="bestCallback" value="${ea(v(row?.bestCallback))}" placeholder="Tomorrow 2 PM"/></div>
        `;
      }

      if(tabId === "mailList"){
        modalForm.innerHTML = `
          <div><label>Recipient (guest or staff)</label><input id="recipient" value="${ea(v(row?.recipient))}" placeholder="Name"/></div>
          <div><label>From (sender)</label><input id="from" value="${ea(v(row?.from))}" placeholder="Amazon, USPS, Person"/></div>
          <div><label>Carrier/Type</label><input id="carrier" value="${ea(v(row?.carrier))}" placeholder="USPS, UPS, FedEx, Envelope"/></div>
          <div><label>Tracking #</label><input id="tracking" value="${ea(v(row?.tracking))}" placeholder="Optional"/></div>
          <div class="full"><label>Received date and time</label><input id="receivedDateTime" value="${ea(v(row?.receivedDateTime) || nowString())}" /></div>
          <div><label>Stored location</label><input id="storageLocation" value="${ea(v(row?.storageLocation))}" placeholder="Shelf A, Locker 2"/></div>
          <div><label>Picked up</label>
            <select id="pickedUpDone">
              <option value="false">At Desk</option>
              <option value="true">Picked Up</option>
            </select>
          </div>
          <div class="full"><label>Picked up details (who, contact, date/time)</label><input id="pickedUpDetails" value="${ea(v(row?.pickedUpDetails))}" placeholder="Picked up by John, (303)..., Jan 30 3:10 PM"/></div>
        `;
      }

      if(tabId === "lost"){
        modalForm.innerHTML = `
          <div><label>Item</label><input id="item" value="${ea(v(row?.item))}" placeholder="Wallet, Key, Phone"/></div>
          <div><label>Owner/Guest</label><input id="owner" value="${ea(v(row?.owner))}" placeholder="Name"/></div>
          <div class="full"><label>Contact details</label><input id="contact" value="${ea(v(row?.contact))}" placeholder="Phone or email"/></div>
          <div><label>Lost date and time</label><input id="lostDateTime" value="${ea(v(row?.lostDateTime) || nowString())}"/></div>
          <div><label>Where lost</label><input id="whereLost" value="${ea(v(row?.whereLost))}" placeholder="Hall lobby, Room 210"/></div>
          <div class="full"><label>Notes</label><textarea id="notes" placeholder="Extra info to help find it">${e(v(row?.notes))}</textarea></div>
          <div class="full"><label>Resolution update (when found, given to who, contact, where found)</label><textarea id="resolution" placeholder="Found in ..., returned to ..., contact ...">${e(v(row?.resolution))}</textarea></div>
          <div><label>Mark as done</label>
            <select id="done">
              <option value="false">Open</option>
              <option value="true">Done</option>
            </select>
          </div>
          <div><label>Optional internal tag</label><input id="tag" value="${ea(v(row?.tag))}" placeholder="FYI"/></div>
        `;
      }

      if(tabId === "found"){
        modalForm.innerHTML = `
          <div><label>Item</label><input id="item" value="${ea(v(row?.item))}" placeholder="Glasses, Key, Charger"/></div>
          <div><label>Found date and time</label><input id="foundDateTime" value="${ea(v(row?.foundDateTime) || nowString())}"/></div>
          <div><label>Found where</label><input id="foundWhere" value="${ea(v(row?.foundWhere))}" placeholder="Front desk, Hall entry"/></div>
          <div><label>Added by</label><input id="addedBy" value="${ea(v(row?.addedBy))}" placeholder="Staff name"/></div>
          <div class="full"><label>Notes</label><textarea id="notes" placeholder="Description, color, brand, etc">${e(v(row?.notes))}</textarea></div>
          <div><label>Claimed</label>
            <select id="claimed">
              <option value="false">Unclaimed</option>
              <option value="true">Claimed</option>
            </select>
          </div>
          <div class="full"><label>Claim details (who claimed, contact, date/time)</label><input id="claimDetails" value="${ea(v(row?.claimDetails))}" placeholder="Claimed by ..., (303)..., Jan 30 4:20 PM"/></div>
        `;
      }

      if(tabId === "deskNotes"){
        modalForm.innerHTML = `
          <div><label>Added by</label><input id="addedBy" value="${ea(v(row?.addedBy))}" placeholder="Staff name"/></div>
          <div><label>Date and time</label><input id="dateTime" value="${ea(v(row?.dateTime) || nowString())}"/></div>
          <div><label>Priority</label>
            <select id="priority">
              <option>FYI</option>
              <option>Important</option>
              <option>Urgent</option>
            </select>
          </div>
          <div class="full"><label>Message</label><textarea id="message" placeholder="Heads up note">${e(v(row?.message))}</textarea></div>
        `;
      }

      if(tabId === "docs"){
        modalForm.innerHTML = `
          <div><label>Document name</label><input id="name" value="${ea(v(row?.name))}" placeholder="Emergency Contacts"/></div>
          <div><label>URL</label><input id="url" value="${ea(v(row?.url))}" placeholder="https://..."/></div>
          <div class="full"><label>Notes</label><input id="notes" value="${ea(v(row?.notes))}" placeholder="What is this document for?"/></div>
        `;
      }

      modal.classList.add("active");

      // Preselect dropdown values for edit
      if(tabId === "mailList"){
        const picked = (row?.pickedUpDone ? "true" : "false");
        document.getElementById("pickedUpDone").value = picked;
      }
      if(tabId === "lost"){
        document.getElementById("done").value = (row?.done ? "true" : "false");
      }
      if(tabId === "found"){
        document.getElementById("claimed").value = (row?.claimed ? "true" : "false");
      }
      if(tabId === "deskNotes"){
        document.getElementById("priority").value = v(row?.priority) || "FYI";
      }

      modalSave.onclick = () => saveModal(tabId, rowId);
    }

    function closeModal(){
      modal.classList.remove("active");
      modalForm.innerHTML = "";
      state.editing = null;
    }

    modalCancel.onclick = closeModal;
    modal.addEventListener("click", (ev) => { if(ev.target === modal) closeModal(); });
    document.addEventListener("keydown", (ev) => { if(ev.key === "Escape") closeModal(); });

    function readInput(id){
      const el = document.getElementById(id);
      return el ? el.value.trim() : "";
    }

    function saveModal(tabId, rowId){
      const all = getHallData();
      const rows = all.halls[state.hall][tabId] || [];

      function upsert(obj){
        if(!rowId){
          obj._id = uid();
          rows.unshift(obj);
        } else {
          const idx = rows.findIndex(r => r._id === rowId);
          if(idx >= 0) rows[idx] = { ...rows[idx], ...obj };
        }
        all.halls[state.hall][tabId] = rows;
        store.saveAll(all);
      }

      if(tabId === "callLog"){
        const whoCalled = readInput("whoCalled");
        const phoneNumber = readInput("phoneNumber");
        const callDateTime = readInput("callDateTime") || nowString();
        const message = readInput("message");
        const takenBy = readInput("takenBy");
        const bestCallback = readInput("bestCallback");
        if(!whoCalled || !message) return;
        upsert({ whoCalled, phoneNumber, callDateTime, message, takenBy, bestCallback });
      }

      if(tabId === "mailList"){
        const recipient = readInput("recipient");
        const from = readInput("from");
        const carrier = readInput("carrier");
        const tracking = readInput("tracking");
        const receivedDateTime = readInput("receivedDateTime") || nowString();
        const storageLocation = readInput("storageLocation");
        const pickedUpDone = (readInput("pickedUpDone") === "true");
        const pickedUpDetails = readInput("pickedUpDetails");
        if(!recipient || !receivedDateTime) return;
        upsert({ recipient, from, carrier, tracking, receivedDateTime, storageLocation, pickedUpDone, pickedUpDetails });
      }

      if(tabId === "lost"){
        const item = readInput("item");
        const owner = readInput("owner");
        const contact = readInput("contact");
        const lostDateTime = readInput("lostDateTime") || nowString();
        const whereLost = readInput("whereLost");
        const notes = readInput("notes");
        const resolution = readInput("resolution");
        const done = (readInput("done") === "true");
        const tag = readInput("tag");
        if(!item) return;
        upsert({ item, owner, contact, lostDateTime, whereLost, notes, resolution, done, tag });
      }

      if(tabId === "found"){
        const item = readInput("item");
        const foundDateTime = readInput("foundDateTime") || nowString();
        const foundWhere = readInput("foundWhere");
        const addedBy = readInput("addedBy");
        const notes = readInput("notes");
        const claimed = (readInput("claimed") === "true");
        const claimDetails = readInput("claimDetails");
        if(!item) return;
        upsert({ item, foundDateTime, foundWhere, addedBy, notes, claimed, claimDetails });
      }

      if(tabId === "deskNotes"){
        const addedBy = readInput("addedBy");
        const dateTime = readInput("dateTime") || nowString();
        const priority = readInput("priority") || "FYI";
        const message = readInput("message");
        if(!addedBy || !message) return;
        upsert({ addedBy, dateTime, priority, message });
      }

      if(tabId === "docs"){
        const name = readInput("name");
        const url = readInput("url");
        const notes = readInput("notes");
        if(!name) return;
        upsert({ name, url, notes });
      }

      closeModal();
      renderContent();
    }

    /* ===========================
       Delete / Edit
       =========================== */

    function deleteRow(tabId, rowId){
      if(!confirm("Delete this entry?")) return;
      const all = getHallData();
      const rows = all.halls[state.hall][tabId] || [];
      const next = rows.filter(r => r._id !== rowId);
      all.halls[state.hall][tabId] = next;
      store.saveAll(all);
      renderContent();
    }

    function editRow(tabId, rowId){
      state.tab = tabId;
      render();
      openModalForTab(tabId, rowId);
    }

    /* ===========================
       Export
       =========================== */

    function exportHall(){
      const all = getHallData();
      const hallObj = all.halls[state.hall] || {};
      const payload = {
        hall: state.hall,
        exportedAt: new Date().toISOString(),
        data: hallObj
      };

      const text = JSON.stringify(payload, null, 2);
      const blob = new Blob([text], {type:"application/json"});
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = (state.hall.replace(/\s+/g,"_").toLowerCase()) + "_export.json";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    /* ===========================
       Public hooks for onclick
       =========================== */

    window.appPickHall = (hall) => routeToHall(hall);
    window.appSetTab = (tab) => setTab(tab);
    window.appDelete = (tab, id) => deleteRow(tab, id);
    window.appEdit = (tab, id) => editRow(tab, id);

    /* ===========================
       Boot
       =========================== */

    (function boot(){
      const p = parseHash();
      if(p.hall){
        state.hall = p.hall;
        state.tab = p.tab || "deskNotes";
      }
      render();
    })();
  </script>
</body>
</html>
